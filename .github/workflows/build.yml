name: Build DLL

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build configuration'
        required: false
        default: 'release'
        type: choice
        options:
          - debug
          - release
          - alpha

jobs:
  build:
    name: Build ${{ matrix.configuration }}
    runs-on: windows-latest
    
    strategy:
      fail-fast: false
      matrix:
        configuration: ${{ github.event.inputs.configuration && fromJSON(format('["{0}"]', github.event.inputs.configuration)) || fromJSON('["debug", "release", "alpha"]') }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
      
    - name: Install LLVM Component for Visual Studio
      shell: pwsh
      run: |
        Write-Host "Installing LLVM/Clang component for Visual Studio..."
        $vsPath = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -property installationPath
        if (-not $vsPath) {
          Write-Error "Visual Studio installation not found"
          exit 1
        }
        Write-Host "Found Visual Studio at: $vsPath"
        
        # Check if LLVM is already installed
        $llvmBasePath = Join-Path $vsPath "VC\Tools\Llvm\x64\lib\clang"
        $needsInstall = -not (Test-Path $llvmBasePath)
        
        if ($needsInstall) {
          Write-Host "LLVM not found, installing component..."
          $vsInstaller = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vs_installer.exe"
          if (-not (Test-Path $vsInstaller)) {
            Write-Error "Visual Studio Installer not found"
            exit 1
          }
          
          # Install LLVM/Clang component
          $componentId = "Microsoft.VisualStudio.Component.VC.Llvm.Clang"
          Write-Host "Installing component: $componentId"
          
          $arguments = @(
            "modify",
            "--installPath", "`"$vsPath`"",
            "--add", $componentId,
            "--quiet",
            "--norestart",
            "--wait"
          )
          
          $process = Start-Process -FilePath $vsInstaller -ArgumentList $arguments -Wait -PassThru -NoNewWindow
          
          if ($process.ExitCode -eq 0 -or $process.ExitCode -eq 3010) {
            Write-Host "LLVM component installation completed (exit code: $($process.ExitCode))"
            Start-Sleep -Seconds 10
          } else {
            Write-Warning "LLVM component installation returned exit code: $($process.ExitCode)"
          }
        } else {
          Write-Host "LLVM already installed"
        }
        
        # Verify installation
        if (Test-Path $llvmBasePath) {
          $versions = Get-ChildItem -Path $llvmBasePath -Directory | Select-Object -ExpandProperty Name | Sort-Object -Descending
          Write-Host "✓ Available LLVM versions: $($versions -join ', ')"
        } else {
          Write-Warning "LLVM path still not found after installation attempt"
        }
        
    - name: Build Solution
      shell: pwsh
      run: |
        $solution = "${{ github.workspace }}\supremacy_csgo.sln"
        $config = "${{ matrix.configuration }}"
        $platform = "x86"
        
        Write-Host "Building configuration: $config"
        Write-Host "Platform: $platform"
        Write-Host "Solution: $solution"
        Write-Host "MSBuild should be available in PATH"
        
        msbuild $solution `
          /p:Configuration=$config `
          /p:Platform=$platform `
          /m `
          /nologo `
          /verbosity:minimal
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Build failed with exit code $LASTEXITCODE"
          exit $LASTEXITCODE
        }
        
    - name: Verify Output
      shell: pwsh
      run: |
        $config = "${{ matrix.configuration }}"
        $outputPath = "${{ github.workspace }}\output\$config"
        $dllPath = Join-Path $outputPath "system32.dll"
        
        Write-Host "Checking for DLL at: $dllPath"
        
        if (Test-Path $dllPath) {
          $fileInfo = Get-Item $dllPath
          Write-Host "✓ DLL found: $($fileInfo.FullName)"
          Write-Host "  Size: $($fileInfo.Length) bytes"
          Write-Host "  Last modified: $($fileInfo.LastWriteTime)"
        } else {
          Write-Error "DLL not found at expected location: $dllPath"
          Write-Host "Contents of output directory:"
          if (Test-Path $outputPath) {
            Get-ChildItem -Path $outputPath -Recurse | ForEach-Object {
              Write-Host "  $($_.FullName)"
            }
          } else {
            Write-Host "  Output directory does not exist"
          }
          exit 1
        }
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: system32-${{ matrix.configuration }}
        path: output/${{ matrix.configuration }}/system32.dll
        retention-days: 30
        if-no-files-found: error

