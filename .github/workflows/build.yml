name: Build DLL

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build configuration'
        required: false
        default: 'release'
        type: choice
        options:
          - debug
          - release
          - alpha

jobs:
  build:
    name: Build ${{ matrix.configuration }}
    runs-on: windows-latest
    
    strategy:
      fail-fast: false
      matrix:
        configuration: ${{ github.event.inputs.configuration && fromJSON(format('["{0}"]', github.event.inputs.configuration)) || fromJSON('["debug", "release", "alpha"]') }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
      
    - name: Check and Install LLVM
      shell: pwsh
      id: llvm_check
      run: |
        Write-Host "Checking for available LLVM versions in Visual Studio..."
        $vsPath = & "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe" -latest -property installationPath
        if (-not $vsPath) {
          Write-Error "Visual Studio installation not found"
          exit 1
        }
        Write-Host "Found Visual Studio at: $vsPath"
        
        $llvmBasePath = Join-Path $vsPath "VC\Tools\Llvm\x64\lib\clang"
        $availableVersion = $null
        
        if (Test-Path $llvmBasePath) {
          $versions = Get-ChildItem -Path $llvmBasePath -Directory | Select-Object -ExpandProperty Name | Sort-Object -Descending
          Write-Host "Available LLVM versions: $($versions -join ', ')"
          
          # Try to find version 16, 15, or 14
          foreach ($version in @("16", "15", "14")) {
            if ($versions -contains $version) {
              $availableVersion = $version
              Write-Host "Found LLVM version: $version"
              break
            }
          }
        }
        
        # If no LLVM found, try to install it
        if (-not $availableVersion) {
          Write-Host "No suitable LLVM version found, attempting to install LLVM component..."
          $vsInstaller = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vs_installer.exe"
          if (Test-Path $vsInstaller) {
            # Try installing LLVM/Clang component
            $componentId = "Microsoft.VisualStudio.Component.VC.Llvm.Clang"
            Write-Host "Installing component: $componentId"
            
            $process = Start-Process -FilePath $vsInstaller -ArgumentList "modify", "--installPath", "`"$vsPath`"", "--add", $componentId, "--quiet", "--norestart", "--wait" -Wait -PassThru -NoNewWindow
            if ($process.ExitCode -eq 0) {
              Write-Host "LLVM component installation completed"
              # Check again after installation
              Start-Sleep -Seconds 5
              if (Test-Path $llvmBasePath) {
                $versions = Get-ChildItem -Path $llvmBasePath -Directory | Select-Object -ExpandProperty Name | Sort-Object -Descending
                foreach ($version in @("16", "15", "14")) {
                  if ($versions -contains $version) {
                    $availableVersion = $version
                    Write-Host "Found LLVM version after installation: $version"
                    break
                  }
                }
              }
            } else {
              Write-Warning "Failed to install LLVM component, exit code: $($process.ExitCode)"
            }
          }
        }
        
        # Use the first available version if still not found
        if (-not $availableVersion -and (Test-Path $llvmBasePath)) {
          $versions = Get-ChildItem -Path $llvmBasePath -Directory | Select-Object -ExpandProperty Name | Sort-Object -Descending
          if ($versions.Count -gt 0) {
            $availableVersion = $versions[0]
            Write-Host "Using first available LLVM version: $availableVersion"
          }
        }
        
        if (-not $availableVersion) {
          if (Test-Path $llvmBasePath) {
            $allVersions = Get-ChildItem -Path $llvmBasePath -Directory | Select-Object -ExpandProperty Name
            Write-Error "No suitable LLVM version found. Available versions: $($allVersions -join ', ')"
          } else {
            Write-Error "No LLVM installation found in Visual Studio"
          }
          exit 1
        }
        
        Write-Host "Using LLVM version: $availableVersion"
        echo "llvm_version=$availableVersion" >> $env:GITHUB_OUTPUT
        
    - name: Update Project LLVM Version
      shell: pwsh
      run: |
        $llvmVersion = "${{ steps.llvm_check.outputs.llvm_version }}"
        Write-Host "Updating project to use LLVM version: $llvmVersion"
        
        $projectFile = "${{ github.workspace }}\supremacy_csgo.vcxproj"
        $content = Get-Content $projectFile -Raw
        $content = $content -replace '<LLVMToolsVersion>\d+</LLVMToolsVersion>', "<LLVMToolsVersion>$llvmVersion</LLVMToolsVersion>"
        Set-Content -Path $projectFile -Value $content -NoNewline
        
        Write-Host "Project file updated successfully"
        
    - name: Setup Clang
      uses: egor-tensin/setup-clang@v1
      with:
        version: ${{ steps.llvm_check.outputs.llvm_version }}
        platform: x64
        
    - name: Build Solution
      shell: pwsh
      run: |
        $solution = "${{ github.workspace }}\supremacy_csgo.sln"
        $config = "${{ matrix.configuration }}"
        $platform = "x86"
        
        Write-Host "Building configuration: $config"
        Write-Host "Platform: $platform"
        Write-Host "Solution: $solution"
        Write-Host "MSBuild should be available in PATH"
        
        msbuild $solution `
          /p:Configuration=$config `
          /p:Platform=$platform `
          /m `
          /nologo `
          /verbosity:minimal
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Build failed with exit code $LASTEXITCODE"
          exit $LASTEXITCODE
        }
        
    - name: Verify Output
      shell: pwsh
      run: |
        $config = "${{ matrix.configuration }}"
        $outputPath = "${{ github.workspace }}\output\$config"
        $dllPath = Join-Path $outputPath "system32.dll"
        
        Write-Host "Checking for DLL at: $dllPath"
        
        if (Test-Path $dllPath) {
          $fileInfo = Get-Item $dllPath
          Write-Host "âœ“ DLL found: $($fileInfo.FullName)"
          Write-Host "  Size: $($fileInfo.Length) bytes"
          Write-Host "  Last modified: $($fileInfo.LastWriteTime)"
        } else {
          Write-Error "DLL not found at expected location: $dllPath"
          Write-Host "Contents of output directory:"
          if (Test-Path $outputPath) {
            Get-ChildItem -Path $outputPath -Recurse | ForEach-Object {
              Write-Host "  $($_.FullName)"
            }
          } else {
            Write-Host "  Output directory does not exist"
          }
          exit 1
        }
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: system32-${{ matrix.configuration }}
        path: output/${{ matrix.configuration }}/system32.dll
        retention-days: 30
        if-no-files-found: error

